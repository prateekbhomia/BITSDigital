<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BITS Pilani Digital Trimester Grading App</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(180deg, #f3f0ff, #ffffff);
  padding: 24px;
  max-width: 1200px;
  margin: auto;
}

header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

header img { height: 60px; }

h1 { color: #3f2a7a; margin: 0; }
h3 { color: #5b3cc4; }

section {
  background: #fff;
  padding: 18px;
  margin-bottom: 18px;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(91,60,196,0.12);
}

input, select {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #c7c2f4;
  width: 320px;
}

button {
  padding: 10px 18px;
  background: #5b3cc4;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 12px;
}

button.secondary {
  background: #ede9fe;
  color: #3f2a7a;
  border: 1px solid #c7c2f4;
}

button:disabled {
  background: #aaa;
  cursor: not-allowed;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(220px, 1fr));
  gap: 20px;
}

.grade-card {
  border: 1px solid #e0dcfa;
  padding: 14px;
  border-radius: 10px;
}

.min-select {
  border: 2px solid #f59e0b;
  background-color: #fff7ed;
  width: 100%;
}

.max-select {
  border: 2px solid #3b82f6;
  background-color: #eff6ff;
  width: 100%;
}

.error {
  color: #b91c1c;
  font-weight: bold;
  margin-top: 10px;
}

.preview {
  background: #faf8ff;
  border: 1px dashed #c7c2f4;
  padding: 12px;
  margin-top: 14px;
  border-radius: 8px;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 12px;
}

th, td {
  border: 1px solid #d4d1fa;
  padding: 10px;
  text-align: center;
}

th {
  background: #ede9fe;
  color: #3f2a7a;
}

.hidden { display: none; }

footer {
  margin-top: 28px;
  font-size: 12px;
  color: #555;
  text-align: center;
}
</style>
</head>

<body>

<header>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="BITS Pilani Digital Logo">
  <h1>BITS Pilani Digital Trimester Grading App</h1>
</header>

<!-- STEP 1 -->
<section id="instructorSection">
<h3>Step 1: Instructor Details (Mandatory)</h3>
<input id="instName" placeholder="Instructor Name"><br>
<input id="instId" placeholder="PSRN / Guest Faculty ID"><br>
<input id="instEmail" placeholder="BITS Email ID"><br>
<div id="instError" class="error"></div>
<button id="proceedBtn" disabled onclick="proceed()">Proceed</button>
</section>

<!-- STEP 2 -->
<section id="uploadSection" class="hidden">
<h3>Step 2: Upload Course Marks Excel File</h3>
<input type="file" id="fileInput" accept=".xlsx">
</section>

<section id="courseSection" class="hidden">
<h3>Select Course</h3>
<select id="courseSelect">
<option value="">-- Select Course --</option>
</select>
</section>

<!-- STEP 3 -->
<section id="gradingSection" class="hidden">

<h3>Define Grade Ranges</h3>
<div class="grid" id="gradeGrid"></div>
<div id="rangeError" class="error"></div>

<button class="secondary" onclick="resetDefaults()">
Reset to Standard BITS Digital Scheme
</button>

<div id="livePreview" class="preview"></div>
<div id="gradeSummaryTable"></div>

<button id="generateBtn" onclick="generate()" disabled>
Generate Histogram & Grades
</button>

<h3>ðŸ“Š Histogram</h3>
<canvas id="histCanvas" width="1000" height="360"></canvas>

<div id="summarySection"></div>
<div id="downloadSection"></div>

</section>

<footer>
BITS Pilani Digital | Trimester Grading App | Version 1.0
</footer>

<script>
/* GLOBALS */
let rawData=[], gradedResults=[];
const grades=["A","A-","B","B-","C","C-","D","E"];
const defaults={
"A":[80,100],"A-":[70,79],"B":[60,69],"B-":[50,59],
"C":[40,49],"C-":[30,39],"D":[20,29],"E":[0,19]
};

const gradeColors={
"A":"#15803d","A-":"#4ade80","B":"#2563eb","B-":"#38bdf8",
"C":"#f59e0b","C-":"#fb923c","D":"#ef4444","E":"#b91c1c"
};

const domains=[
"@bitspilani-digital.edu.in","@bits-pilani.ac.in",
"@pilani.bits-pilani.ac.in","@hyderabad.bits-pilani.ac.in",
"@goa.bits-pilani.ac.in"
];

/* INSTRUCTOR GATE */
function validInstructor(){
return instName.value && instId.value &&
domains.some(d=>instEmail.value.endsWith(d));
}
["instName","instId","instEmail"].forEach(id=>{
document.getElementById(id).oninput=()=>{
if(validInstructor()){
instError.textContent="";
proceedBtn.disabled=false;
}else{
instError.textContent="Enter valid instructor details with official BITS email ID.";
proceedBtn.disabled=true;
}
};
});
function proceed(){
instructorSection.classList.add("hidden");
uploadSection.classList.remove("hidden");
}

/* FILE UPLOAD */
fileInput.onchange=e=>{
const r=new FileReader();
r.onload=ev=>{
const wb=XLSX.read(ev.target.result,{type:"binary"});
rawData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
courseSelect.innerHTML='<option value="">-- Select Course --</option>';
[...new Set(rawData.map(r=>r.Course))].forEach(c=>{
courseSelect.innerHTML+=`<option>${c}</option>`;
});
courseSection.classList.remove("hidden");
};
r.readAsBinaryString(e.target.files[0]);
};

courseSelect.onchange=()=>{
if(courseSelect.value){
gradingSection.classList.remove("hidden");
validateRanges();
}
};

/* GRADE UI */
function dropdown(id){
const cls=id.endsWith("min")?"min-select":"max-select";
let h=`<select id="${id}" class="${cls}" onchange="validateRanges()">`;
for(let i=0;i<=100;i++)h+=`<option value="${i}">${i}</option>`;
return h+"</select>";
}

grades.forEach(g=>{
gradeGrid.innerHTML+=`
<div class="grade-card">
<strong style="color:${gradeColors[g]}">${g}</strong><br><br>
<label>Min</label>${dropdown(g+"min")}
<label style="margin-top:6px;display:block;">Max</label>${dropdown(g+"max")}
</div>`;
});

function resetDefaults(){
grades.forEach(g=>{
document.getElementById(g+"min").value=defaults[g][0];
document.getElementById(g+"max").value=defaults[g][1];
});
validateRanges();
}
resetDefaults();

/* VALIDATION & PREVIEW */
function validateRanges(){
let err="";
for(let i=0;i<grades.length;i++){
const g=grades[i];
const min=+document.getElementById(g+"min").value;
const max=+document.getElementById(g+"max").value;
if(min>=max){err=`Invalid range for ${g}`;break;}
if(i>0){
const pmin=+document.getElementById(grades[i-1]+"min").value;
if(max!==pmin-1){err="Grade ranges must be continuous";break;}
}
}
rangeError.textContent=err;
generateBtn.disabled=!!err;
if(!err) updatePreview();
}

/* PREVIEW + SUMMARY */
function updatePreview(){
let counts={},total=0;
grades.forEach(g=>counts[g]=0);
rawData.filter(r=>r.Course===courseSelect.value).forEach(r=>{
total++;
for(let g of grades){
const min=+document.getElementById(g+"min").value;
const max=+document.getElementById(g+"max").value;
if(r["Total Marks"]>=min&&r["Total Marks"]<=max){
counts[g]++;break;
}
}
});
let html=`<strong>Grade Distribution Preview (${total} students)</strong><br>`;
grades.forEach(g=>{
const pct=((counts[g]/total)*100).toFixed(1);
html+=`<span style="color:${gradeColors[g]};font-weight:600">
${g}: ${counts[g]} (${pct}%)
</span><br>`;
});
livePreview.innerHTML=html;

let table=`<table>
<tr>${grades.map(g=>`<th style="color:${gradeColors[g]}">${g}</th>`).join("")}</tr>
<tr>${grades.map(g=>`<td style="color:${gradeColors[g]};font-weight:600">${counts[g]}</td>`).join("")}</tr>
</table>`;
gradeSummaryTable.innerHTML="<h3>Grade-wise Class Summary</h3>"+table;
}

/* GENERATE */
function generate(){
gradedResults=[];
rawData.filter(r=>r.Course===courseSelect.value).forEach(r=>{
for(let g of grades){
const min=+document.getElementById(g+"min").value;
const max=+document.getElementById(g+"max").value;
if(r["Total Marks"]>=min&&r["Total Marks"]<=max){
gradedResults.push({...r,grade:g});break;
}
}
});
drawHistogram();
renderSummary();
}

/* HISTOGRAM */
function drawHistogram(){
const ctx=histCanvas.getContext("2d");
ctx.clearRect(0,0,1000,360);
let b=Array(10).fill(0);
gradedResults.forEach(r=>b[Math.min(9,Math.floor(r["Total Marks"]/10))]++);
b.forEach((v,i)=>{
ctx.fillStyle="#5b3cc4";
ctx.fillRect(60+i*90,300-v*18,45,v*18);
ctx.fillStyle="#000";
ctx.fillText(`${i*10}-${i*10+9}`,60+i*90,330);
ctx.fillText(v,75+i*90,290-v*18);
});
}

/* SUMMARY & DOWNLOAD */
function renderSummary(){
let html=`<h3>ðŸ“‹ Student Grades</h3><table>
<tr><th>BITS ID</th><th>Total Marks</th><th>Grade</th></tr>`;
gradedResults.forEach(r=>{
html+=`<tr>
<td>${r["BITS ID"]}</td>
<td>${r["Total Marks"]}</td>
<td style="color:${gradeColors[r.grade]};font-weight:600">${r.grade}</td>
</tr>`;
});
html+="</table>";
summarySection.innerHTML=html;
downloadSection.innerHTML=`
<button onclick="downloadGrades()">Finalize Grades & Download Sheet</button>
<button class="secondary" onclick="location.reload()">Start New Course Grading</button>`;
}

function downloadGrades(){
if(!confirm("You are about to finalize grades. Continue?"))return;
let csv=`Instructor Name,${instName.value}\nID,${instId.value}\nEmail,${instEmail.value}\n\nBITS ID,Course,Grade\n`;
gradedResults.forEach(r=>csv+=`${r["BITS ID"]},${r.Course},${r.grade}\n`);
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download="final_grades.csv";
a.click();
}
</script>

</body>
</html>
