<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BITS Pilani Digital Advanced Grading App</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(180deg, #f3f0ff, #ffffff);
  padding: 24px;
  max-width: 1200px;
  margin: auto;
}

header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

header img { height: 60px; }

h1 { color: #3f2a7a; margin: 0; }
h3 { color: #5b3cc4; }

section {
  background: #fff;
  padding: 18px;
  margin-bottom: 18px;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(91,60,196,0.12);
}

input, select {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #c7c2f4;
  width: 320px;
}

button {
  padding: 10px 18px;
  background: #5b3cc4;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 12px;
}

button:disabled {
  background: #aaa;
  cursor: not-allowed;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(220px, 1fr));
  gap: 20px;
}

.grade-card {
  border: 1px solid #e0dcfa;
  padding: 14px;
  border-radius: 10px;
}

.preview {
  background: #faf8ff;
  border: 1px dashed #c7c2f4;
  padding: 12px;
  margin-top: 14px;
  border-radius: 8px;
}

.error {
  color: #b91c1c;
  font-weight: bold;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 12px;
}

th, td {
  border: 1px solid #d4d1fa;
  padding: 10px;
  text-align: center;
}

th {
  background: #ede9fe;
  color: #3f2a7a;
}

.hidden { display: none; }
</style>
</head>

<body>

<header>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="BITS Pilani Digital Logo">
  <h1>BITS Pilani Digital Advanced Grading App</h1>
</header>

<!-- LANDING -->
<section id="welcomeSection">
  <input id="instName" placeholder="Enter your first name">
  <button onclick="proceed()">Continue</button>

  <h3 style="margin-top:16px;">How to use this app</h3>
  <ol>
    <li>Upload course marks Excel</li>
    <li>Select the course</li>
    <li>Review histogram, bell curve and statistics</li>
    <li>Adjust grade ranges</li>
    <li>Finalize and download grades</li>
  </ol>
</section>

<!-- UPLOAD -->
<section id="uploadSection" class="hidden">
  <h3 id="greeting"></h3>
  <input type="file" id="fileInput" accept=".xlsx">
</section>

<section id="courseSection" class="hidden">
  <h3>Select Course</h3>
  <select id="courseSelect">
    <option value="">-- Select Course --</option>
  </select>
</section>

<!-- ANALYSIS -->
<section id="analysisSection" class="hidden">
  <h3>ðŸ“Š Marks Distribution</h3>
  <canvas id="histCanvas" width="1000" height="360"></canvas>

  <h3>Class Statistics</h3>
  <table>
    <tr>
      <th>Highest</th>
      <th>Lowest</th>
      <th>Average</th>
      <th>Median</th>
    </tr>
    <tr>
      <td id="maxMarks"></td>
      <td id="minMarks"></td>
      <td id="avgMarks"></td>
      <td id="medianMarks"></td>
    </tr>
  </table>
</section>

<!-- GRADING -->
<section id="gradingSection" class="hidden">
  <h3>Define Grade Ranges</h3>
  <div class="grid" id="gradeGrid"></div>
  <div id="rangeError" class="error"></div>
  <div id="livePreview" class="preview"></div>

  <button id="generateBtn" onclick="generate()" disabled>
    Finalize Grades & Download
  </button>
</section>

<script>
let instructorName="", rawData=[], gradedResults=[];
const grades=["A","A-","B","B-","C","C-","D","E"];
const defaults={
"A":[80,100],"A-":[70,79],"B":[60,69],"B-":[50,59],
"C":[40,49],"C-":[30,39],"D":[20,29],"E":[0,19]
};

function proceed(){
  instructorName=instName.value.trim();
  if(!instructorName){ alert("Please enter your first name"); return; }
  welcomeSection.classList.add("hidden");
  uploadSection.classList.remove("hidden");
  greeting.innerText=`Hi ${instructorName}, welcome to BITS Pilani Digitalâ€™s Advanced Grading App`;
}

fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:"binary"});
    rawData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    courseSelect.innerHTML='<option value="">-- Select Course --</option>';
    [...new Set(rawData.map(r=>r.Course))].forEach(c=>{
      courseSelect.innerHTML+=`<option>${c}</option>`;
    });
    courseSection.classList.remove("hidden");
  };
  r.readAsBinaryString(e.target.files[0]);
};

courseSelect.onchange=()=>{
  if(courseSelect.value){
    analysisSection.classList.remove("hidden");
    gradingSection.classList.remove("hidden");
    drawHistogram();
    computeStats();
    resetDefaults();
    validateRanges();
  }
};

function dropdown(id){
  let h=`<select id="${id}" onchange="validateRanges()">`;
  for(let i=0;i<=100;i++) h+=`<option value="${i}">${i}</option>`;
  return h+"</select>";
}

grades.forEach(g=>{
  gradeGrid.innerHTML+=`
  <div class="grade-card">
    <strong>${g}</strong><br><br>
    Min ${dropdown(g+"min")}<br>
    Max ${dropdown(g+"max")}
  </div>`;
});

function resetDefaults(){
  grades.forEach(g=>{
    document.getElementById(g+"min").value=defaults[g][0];
    document.getElementById(g+"max").value=defaults[g][1];
  });
}

function validateRanges(){
  let err="";
  for(let i=0;i<grades.length;i++){
    const g=grades[i];
    const min=+document.getElementById(g+"min").value;
    const max=+document.getElementById(g+"max").value;
    if(min>=max){ err="Invalid grade ranges"; break; }
    if(i>0){
      const pmin=+document.getElementById(grades[i-1]+"min").value;
      if(max!==pmin-1){ err="Ranges must be continuous"; break; }
    }
  }
  rangeError.textContent=err;
  generateBtn.disabled=!!err;
  if(!err) updatePreview();
}

function updatePreview(){
  let counts={}, total=0;
  grades.forEach(g=>counts[g]=0);
  rawData.filter(r=>r.Course===courseSelect.value).forEach(r=>{
    total++;
    for(let g of grades){
      const min=+document.getElementById(g+"min").value;
      const max=+document.getElementById(g+"max").value;
      if(r["Total Marks"]>=min&&r["Total Marks"]<=max){
        counts[g]++; break;
      }
    }
  });
  let html=`<strong>Grade Distribution Preview (${total} students)</strong><br>`;
  grades.forEach(g=>html+=`${g}: ${counts[g]}<br>`);
  livePreview.innerHTML=html;
}

function drawHistogram(){
  const ctx=histCanvas.getContext("2d");
  ctx.clearRect(0,0,1000,360);
  let bins=Array(10).fill(0);
  rawData.filter(r=>r.Course===courseSelect.value)
    .forEach(r=>bins[Math.min(9,Math.floor(r["Total Marks"]/10))]++);
  bins.forEach((v,i)=>{
    ctx.fillStyle="#5b3cc4";
    ctx.fillRect(60+i*90,300-v*18,45,v*18);
  });

  // Bell curve
  const marks=rawData.filter(r=>r.Course===courseSelect.value)
    .map(r=>r["Total Marks"]);
  const mean=marks.reduce((a,b)=>a+b,0)/marks.length;
  const std=Math.sqrt(marks.reduce((a,b)=>a+(b-mean)**2,0)/marks.length);

  ctx.strokeStyle="#dc2626";
  ctx.beginPath();
  for(let x=0;x<=100;x++){
    const y=(1/(std*Math.sqrt(2*Math.PI)))*
      Math.exp(-0.5*((x-mean)/std)**2);
    const px=60+(x/10)*90;
    const py=300-y*4000;
    x===0?ctx.moveTo(px,py):ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function computeStats(){
  const marks=rawData.filter(r=>r.Course===courseSelect.value)
    .map(r=>r["Total Marks"]).sort((a,b)=>a-b);
  minMarks.innerText=marks[0];
  maxMarks.innerText=marks[marks.length-1];
  avgMarks.innerText=(marks.reduce((a,b)=>a+b,0)/marks.length).toFixed(2);
  medianMarks.innerText=
    marks.length%2?marks[Math.floor(marks.length/2)]
    :(marks[marks.length/2-1]+marks[marks.length/2])/2;
}

function generate(){
  gradedResults=[];
  rawData.filter(r=>r.Course===courseSelect.value).forEach(r=>{
    for(let g of grades){
      const min=+document.getElementById(g+"min").value;
      const max=+document.getElementById(g+"max").value;
      if(r["Total Marks"]>=min&&r["Total Marks"]<=max){
        gradedResults.push({...r,grade:g}); break;
      }
    }
  });
  let csv=`Instructor,${instructorName}\nBITS ID,Course,Grade\n`;
  gradedResults.forEach(r=>csv+=`${r["BITS ID"]},${r.Course},${r.grade}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="final_grades.csv";
  a.click();
}
</script>

</body>
</html>
