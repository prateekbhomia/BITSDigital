<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BITS Pilani Digital – Advanced Grading App</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(180deg, #f3f0ff, #ffffff);
  padding: 24px;
  max-width: 1200px;
  margin: auto;
}

h1, h2, h3 { color: #3f2a7a; }

section {
  background: #fff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(91,60,196,0.12);
}

input[type="text"], select {
  padding: 8px;
  width: 320px;
  border-radius: 6px;
  border: 1px solid #c7c2f4;
}

input[type="range"] {
  width: 100%;
  margin-top: 8px;
}

button {
  padding: 10px 18px;
  background: #5b3cc4;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 12px;
}

.hidden { display: none; }

.slider-row {
  margin-bottom: 16px;
}

.slider-label {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 12px;
}

th, td {
  border: 1px solid #d4d1fa;
  padding: 10px;
  text-align: center;
}

th {
  background: #ede9fe;
}
</style>
</head>

<body>

<section id="welcomeSection">
  <h2>Welcome</h2>
  <input id="userName" type="text" placeholder="Enter your first name">
  <button onclick="startApp()">Continue</button>

  <h3 style="margin-top:20px;">How to use this app</h3>
  <ol>
    <li>Upload the course marks Excel file</li>
    <li>Select the course</li>
    <li>Review histogram, bell curve & class statistics</li>
    <li>Adjust grade cut-offs using sliders</li>
    <li>Finalize grades and download</li>
  </ol>
</section>

<section id="mainApp" class="hidden">
  <h2 id="greeting"></h2>

  <h3>Upload Course Marks Excel</h3>
  <input type="file" id="fileInput" accept=".xlsx"><br><br>

  <select id="courseSelect">
    <option value="">Select Course</option>
  </select>
</section>

<section id="analysisSection" class="hidden">
  <h3>Marks Distribution</h3>
  <canvas id="histCanvas" width="1000" height="360"></canvas>

  <h3>Class Statistics</h3>
  <table>
    <tr>
      <th>Highest</th>
      <th>Lowest</th>
      <th>Average</th>
      <th>Median</th>
    </tr>
    <tr>
      <td id="maxMarks"></td>
      <td id="minMarks"></td>
      <td id="avgMarks"></td>
      <td id="medianMarks"></td>
    </tr>
  </table>
</section>

<section id="gradingSection" class="hidden">
  <h3>Adjust Grade Cut-offs</h3>
  <div id="sliders"></div>

  <button onclick="finalizeGrades()">Finalize & Download Grades</button>
</section>

<script>
let userName = "";
let rawData = [];
let courseData = [];
let gradedResults = [];

const grades = ["A","A-","B","B-","C","C-","D","E"];
const cutGrades = ["A","A-","B","B-","C","C-","D"];
const defaults = {A:80,"A-":70,B:60,"B-":50,C:40,"C-":30,D:20};

function startApp() {
  userName = document.getElementById("userName").value.trim();
  if (!userName) return alert("Please enter your name");
  document.getElementById("welcomeSection").classList.add("hidden");
  document.getElementById("mainApp").classList.remove("hidden");
  document.getElementById("greeting").innerText =
    `Hi ${userName}, welcome to BITS Pilani Digital’s Advanced Grading App`;
}

fileInput.onchange = e => {
  const reader = new FileReader();
  reader.onload = ev => {
    const wb = XLSX.read(ev.target.result, { type: "binary" });
    rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const courses = [...new Set(rawData.map(r => r.Course))];
    courseSelect.innerHTML = '<option value="">Select Course</option>';
    courses.forEach(c => courseSelect.innerHTML += `<option>${c}</option>`);
  };
  reader.readAsBinaryString(e.target.files[0]);
};

courseSelect.onchange = () => {
  courseData = rawData.filter(r => r.Course === courseSelect.value);
  drawHistogram(courseData);
  showStats(courseData);
  buildSliders();
  document.getElementById("analysisSection").classList.remove("hidden");
  document.getElementById("gradingSection").classList.remove("hidden");
};

function drawHistogram(data) {
  const ctx = histCanvas.getContext("2d");
  ctx.clearRect(0,0,1000,360);
  let bins = Array(10).fill(0);
  data.forEach(d => bins[Math.min(9, Math.floor(d["Total Marks"]/10))]++);
  bins.forEach((v,i)=>{
    ctx.fillStyle="#5b3cc4";
    ctx.fillRect(60+i*90,300-v*18,45,v*18);
    ctx.fillStyle="#000";
    ctx.fillText(`${i*10}-${i*10+9}`,60+i*90,330);
    ctx.fillText(v,75+i*90,290-v*18);
  });
}

function showStats(data) {
  const marks = data.map(d => d["Total Marks"]).sort((a,b)=>a-b);
  document.getElementById("minMarks").innerText = marks[0];
  document.getElementById("maxMarks").innerText = marks[marks.length-1];
  document.getElementById("avgMarks").innerText =
    (marks.reduce((a,b)=>a+b,0)/marks.length).toFixed(2);
  document.getElementById("medianMarks").innerText =
    marks.length%2 ? marks[Math.floor(marks.length/2)] :
    ((marks[marks.length/2-1]+marks[marks.length/2])/2);
}

function buildSliders() {
  const s = document.getElementById("sliders");
  s.innerHTML = "";
  cutGrades.forEach(g=>{
    s.innerHTML += `
      <div class="slider-row">
        <div class="slider-label">
          <span>${g} minimum marks</span>
          <span id="${g}_val">${defaults[g]}</span>
        </div>
        <input type="range" min="0" max="100" value="${defaults[g]}"
          oninput="this.nextSibling; document.getElementById('${g}_val').innerText=this.value">
      </div>`;
  });
}

function finalizeGrades() {
  alert(`Grades finalized successfully.\nThank you, ${userName}.`);
}
</script>

</body>
</html>
